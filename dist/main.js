(function(){var e=10,t=class{constructor(e,t,n){this.messageIndex=0,this.http=t}async httpGet(e){try{let t=await this.http.get(e,{headers:{"User-Agent":`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36`,"Accept-Language":`en-US,en;q=0.9`}});return t.statusCode<200||t.statusCode>=300?{success:!1,body:``,error:`HTTP GET failed (status ${t.statusCode}): ${t.reason}`}:{success:!0,body:t.text}}catch(e){return{success:!1,body:``,error:`HTTP GET error: ${e}`}}}async httpPost(e,t,n){try{let r=await this.http.post(e,{headers:n,data:t});return r.statusCode<200||r.statusCode>=300?{success:!1,body:``,error:`HTTP POST failed (status ${r.statusCode}): ${r.reason}`}:{success:!0,body:r.text}}catch(e){return{success:!1,body:``,error:`HTTP POST error: ${e}`}}}extractYtcfg(e){let t=e.match(/ytcfg\.set\s*\(\s*(\{.+?\})\s*\)\s*;/);if(!t)return null;try{return JSON.parse(t[1])}catch{return null}}rawDecode(e){if(!e||e[0]!==`{`&&e[0]!==`[`)return null;let t=0,n=!1,r=0;for(;r<e.length;){let i=e[r];if(n){if(i===`\\`){r+=2;continue}i===`"`&&(n=!1),r++;continue}if(i===`"`)n=!0;else if(i===`{`||i===`[`)t++;else if((i===`}`||i===`]`)&&(t--,t===0)){let t=e.substring(0,r+1);try{return{obj:JSON.parse(t),endIndex:r+1}}catch{}}r++}return null}searchJson(e,t){let n=e.exec(t);if(!n)return null;let r=n.index+n[0].length;for(;r<t.length&&/\s/.test(t[r]);)r++;if(t[r]!==`{`)return null;let i=t.lastIndexOf(`}`);if(i<=r)return null;let a=t.substring(r,i+1),o=this.rawDecode(a);return o?o.obj:null}extractYtInitialData(e){return this.searchJson(/(?:window\s*\[\s*["']ytInitialData["']\s*\]|ytInitialData)\s*=/,e)}extractDataFromResponse(e){let t=this.extractYtInitialData(e);if(t)return t;try{return JSON.parse(e)}catch{return null}}getLiveChatContinuation(e){return e.continuationContents?.liveChatContinuation||null}extractInitialContinuation(e){try{let t=e.contents?.twoColumnWatchNextResults?.conversationBar?.liveChatRenderer?.continuations;if(t&&t.length>0)return t[0].reloadContinuationData?.continuation||null}catch{}return null}tryGetUnfilteredContinuation(e){try{let t=e.header?.liveChatHeaderRenderer?.viewSelector?.sortFilterSubMenuRenderer?.subMenuItems;if(t&&t.length>1){let e=t[1].continuation?.reloadContinuationData;if(e)return{continuation:e.continuation||null,clickTrackingParams:e.trackingParams||null}}}catch{}return{continuation:null,clickTrackingParams:null}}parseReplayResponse(e){let t=e.actions||[],n=null;for(let e of t)e.replayChatItemAction?.videoOffsetTimeMsec&&(n=Number.parseInt(e.replayChatItemAction.videoOffsetTimeMsec,10));let r=e.continuations,i=null,a=null;if(r&&r.length>0){let e=r[0].liveChatReplayContinuationData;e&&(i=e.continuation||null,a=e.clickTrackingParams||null)}return{actions:t,continuation:i,clickTrackingParams:a,offset:n}}async fetchFragment(e,t,n,r,i){let a={context:t,continuation:n};i!==void 0&&i>0&&(a.currentPlayerState={playerOffsetMs:String(i)});let o=await this.httpPost(e,a,r);if(!o.success)return{success:!1,error:o.error};try{return{success:!0,data:JSON.parse(o.body)}}catch{let e=this.rawDecode(o.body);return e?{success:!0,data:e.obj}:{success:!1,error:`Failed to parse response`}}}extractPlayerResponse(e){return this.searchJson(/ytInitialPlayerResponse\s*=\s*/,e)}extractVideoDurationFromHtml(e){try{let t=this.extractPlayerResponse(e);if(t){let e=t.videoDetails;if(e?.lengthSeconds){let t=Number.parseInt(e.lengthSeconds,10);if(!Number.isNaN(t)&&t>0)return t*1e3}}}catch{}try{let t=e.match(/"lengthSeconds":"(\d+)"/);if(t){let e=Number.parseInt(t[1],10);if(!Number.isNaN(e)&&e>0)return e*1e3}}catch{}return null}async fetchSegment(e,t,n,r,i,a,o,s){let c=[],l=0,u=a,d=a,f=await this.fetchFragment(t,n,r,i,a);if(!f.success||!f.data)return{workerId:e,messages:c,fragments:l,startOffsetMs:u,endOffsetMs:d};let p=this.getLiveChatContinuation(f.data);for(;p;){l++;let r=this.parseReplayResponse(p),m=this.parseActions(r.actions);for(let e of m){let t=e.timestamp*1e3;t>=a&&t<o&&(c.push(e),t>d&&(d=t),l===1&&c.length===1&&(u=t))}if(s?.(e,c.length),r.offset!==null&&r.offset>=o||!r.continuation||(f=await this.fetchFragment(t,n,r.continuation,i),!f.success||!f.data))break;p=this.getLiveChatContinuation(f.data)}return{workerId:e,messages:c,fragments:l,startOffsetMs:u,endOffsetMs:d}}async fetchAllMessages(t,n){this.messageIndex=0;let r=[];n?.({fetchedMessages:0,currentOffsetMs:0,status:`fetching`,message:`Fetching video page...`});let i=`https://www.youtube.com/watch?v=${t}`,a=await this.httpGet(i);if(!a.success)return{success:!1,error:a.error||`Failed to fetch video page`};let o=a.body,s=this.extractYtcfg(o);if(!s)return{success:!1,error:`Could not extract YouTube configuration`};let c=s.INNERTUBE_API_KEY,l=s.INNERTUBE_CONTEXT;if(!c||!l)return{success:!1,error:`Missing API key or context`};let u=l.client.visitorData,d=l.client.clientVersion,f=l.client.userAgent,p=this.extractYtInitialData(o);if(!p)return{success:!1,error:`Could not extract initial data from video page`};let m=this.extractInitialContinuation(p);if(!m)return{success:!1,error:`No chat replay available for this video`};n?.({fetchedMessages:0,currentOffsetMs:0,status:`fetching`,message:`Fetching chat page...`});let h=`https://www.youtube.com/live_chat_replay?continuation=${m}`,g=await this.httpGet(h);if(!g.success)return{success:!1,error:g.error||`Failed to fetch chat page`};let _=this.extractDataFromResponse(g.body);if(!_)return{success:!1,error:`Could not parse chat page data`};let v=this.getLiveChatContinuation(_);if(!v)return{success:!1,error:`No chat data found`};let y=this.tryGetUnfilteredContinuation(v);if(y.continuation)m=y.continuation;else{let e=this.parseReplayResponse(v),t=this.parseActions(e.actions);if(r.push(...t),!e.continuation)return n?.({fetchedMessages:r.length,currentOffsetMs:e.offset||0,status:`complete`,message:`Fetched ${r.length} messages`}),{success:!0,messages:r};m=e.continuation;let i=e.offset||0;t.length>0&&n?.({fetchedMessages:r.length,currentOffsetMs:i,status:`fetching`,message:`Fetched ${r.length} messages...`})}let b=`https://www.youtube.com/youtubei/v1/live_chat/get_live_chat_replay?key=${c}`,x={"Content-Type":`application/json`,"X-YouTube-Client-Name":`1`,"X-YouTube-Client-Version":d,Origin:`https://www.youtube.com`};u&&(x[`X-Goog-Visitor-Id`]=u),f&&(x[`User-Agent`]=f);let S=this.extractVideoDurationFromHtml(o);S||=7200*1e3;let C=S/e,w=[];for(let t=0;t<e;t++)w.push({start:Math.floor(t*C),end:Math.floor((t+1)*C)});w[e-1].end=S+6e4;let T=Array(e).fill(0),E=(e,t)=>{T[e]=t;let i=T.reduce((e,t)=>e+t,0)+r.length;n?.({fetchedMessages:i,currentOffsetMs:0,status:`fetching`,message:`Fetched ${i.toLocaleString()} messages...`})};n?.({fetchedMessages:r.length,currentOffsetMs:0,status:`fetching`,message:`Fetching chat messages...`});let D=w.map((e,t)=>this.fetchSegment(t,b,l,m,x,e.start,e.end,E)),O=await Promise.all(D),k=new Set;for(let e of r)k.add(e.id);O.sort((e,t)=>e.startOffsetMs-t.startOffsetMs);for(let e of O)for(let t of e.messages)k.has(t.id)||(k.add(t.id),r.push(t));return r.sort((e,t)=>e.timestamp-t.timestamp),n?.({fetchedMessages:r.length,currentOffsetMs:r.length>0?r[r.length-1].timestamp*1e3:0,status:`complete`,message:`Fetched ${r.length} messages`}),{success:!0,messages:r}}parseActions(e){let t=[];for(let n of e)if(n.replayChatItemAction){let e=Number.parseInt(n.replayChatItemAction.videoOffsetTimeMsec||`0`,10)/1e3;for(let r of n.replayChatItemAction.actions||[]){let n=r.addChatItemAction?.item;if(n){let r=this.parseItem(n,e);r&&t.push(r)}}}else if(n.addChatItemAction?.item){let e=this.parseItem(n.addChatItemAction.item,0);e&&t.push(e)}return t}parseItem(e,t){let n=this.messageIndex++;if(e.liveChatTextMessageRenderer){let r=e.liveChatTextMessageRenderer,{text:i,messageRuns:a}=this.parseMessageRuns(r.message?.runs);return!i&&a.length===0?null:{id:r.id||`archived-${n}`,type:`text`,timestamp:t,author:r.authorName?.simpleText||`Unknown`,authorPhoto:this.getBestThumbnail(r.authorPhoto?.thumbnails),authorChannelId:r.authorExternalChannelId,authorBadges:this.parseAuthorBadges(r.authorBadges),message:i,messageRuns:a.length>0?a:void 0,timestampText:r.timestampText?.simpleText}}if(e.liveChatPaidMessageRenderer){let r=e.liveChatPaidMessageRenderer,{text:i,messageRuns:a}=this.parseMessageRuns(r.message?.runs);return{id:r.id||`archived-${n}`,type:`superchat`,timestamp:t,author:r.authorName?.simpleText||`Unknown`,authorPhoto:this.getBestThumbnail(r.authorPhoto?.thumbnails),authorChannelId:r.authorExternalChannelId,authorBadges:this.parseAuthorBadges(r.authorBadges),message:i||`(Super Chat)`,messageRuns:a.length>0?a:void 0,timestampText:r.timestampText?.simpleText,amount:r.purchaseAmountText?.simpleText,colors:this.parseSuperChatColors(r)}}if(e.liveChatPaidStickerRenderer){let r=e.liveChatPaidStickerRenderer;return{id:r.id||`archived-${n}`,type:`supersticker`,timestamp:t,author:r.authorName?.simpleText||`Unknown`,authorPhoto:this.getBestThumbnail(r.authorPhoto?.thumbnails),authorChannelId:r.authorExternalChannelId,authorBadges:this.parseAuthorBadges(r.authorBadges),message:`(Super Sticker)`,timestampText:r.timestampText?.simpleText,amount:r.purchaseAmountText?.simpleText,stickerUrl:this.getBestThumbnail(r.sticker?.thumbnails),colors:{bodyBackgroundColor:this.colorToHex(r.backgroundColor),authorNameTextColor:this.colorToHex(r.authorNameTextColor)}}}if(e.liveChatMembershipItemRenderer){let r=e.liveChatMembershipItemRenderer,{text:i}=this.parseMessageRuns(r.headerSubtext?.runs),{text:a,messageRuns:o}=this.parseMessageRuns(r.message?.runs);return{id:r.id||`archived-${n}`,type:`membership`,timestamp:t,author:r.authorName?.simpleText||`Unknown`,authorPhoto:this.getBestThumbnail(r.authorPhoto?.thumbnails),authorChannelId:r.authorExternalChannelId,authorBadges:this.parseAuthorBadges(r.authorBadges),message:a||i||`(New Member)`,messageRuns:o.length>0?o:void 0,timestampText:r.timestampText?.simpleText,membershipLevel:i||void 0}}if(e.liveChatSponsorshipsGiftPurchaseAnnouncementRenderer){let r=e.liveChatSponsorshipsGiftPurchaseAnnouncementRenderer,{text:i}=this.parseMessageRuns(r.header?.liveChatSponsorshipsHeaderRenderer?.primaryText?.runs);return{id:r.id||`archived-${n}`,type:`gift`,timestamp:t,author:r.authorName?.simpleText||`Unknown`,authorPhoto:this.getBestThumbnail(r.authorPhoto?.thumbnails),authorChannelId:r.authorExternalChannelId,message:i||`(Gift Membership)`,timestampText:r.timestampText?.simpleText}}if(e.liveChatViewerEngagementMessageRenderer){let r=e.liveChatViewerEngagementMessageRenderer,{text:i,messageRuns:a}=this.parseMessageRuns(r.message?.runs);return i?{id:r.id||`archived-${n}`,type:`system`,timestamp:t,author:`YouTube`,message:i,messageRuns:a.length>0?a:void 0}:null}return null}parseMessageRuns(e){if(!e?.length)return{text:``,messageRuns:[]};let t=[],n=``;for(let r of e)if(r.text)n+=r.text,t.push({type:`text`,text:r.text});else if(r.emoji){let e=r.emoji.emojiId||``,i=r.emoji.shortcuts?.[0],a=r.emoji.image?.thumbnails?.[0]?.url,o=r.emoji.isCustomEmoji;n+=i||e,t.push({type:`emoji`,emoji:{emojiId:e,shortcut:i,imageUrl:a,isCustom:o}})}return{text:n,messageRuns:t}}parseAuthorBadges(e){if(!e?.length)return;let t=[];for(let n of e){let e=n.liveChatAuthorBadgeRenderer,r=e.icon?.iconType?.toLowerCase(),i=e.tooltip||``,a;r===`verified`?a=`verified`:r===`owner`?a=`owner`:r===`moderator`?a=`moderator`:(r===`member`||e.customThumbnail)&&(a=`member`),a&&t.push({type:a,label:i,customIcon:this.getBestThumbnail(e.customThumbnail?.thumbnails)})}return t.length>0?t:void 0}getBestThumbnail(e){if(e?.length)return[...e].sort((e,t)=>(t.width||0)-(e.width||0))[0]?.url}colorToHex(e){if(e===void 0)return;let t=(e>>>0).toString(16).padStart(8,`0`),n=t.slice(0,2);return`#${t.slice(2)}${n}`}parseSuperChatColors(e){let t={headerBackgroundColor:this.colorToHex(e.headerBackgroundColor),headerTextColor:this.colorToHex(e.headerTextColor),bodyBackgroundColor:this.colorToHex(e.bodyBackgroundColor),bodyTextColor:this.colorToHex(e.bodyTextColor),authorNameTextColor:this.colorToHex(e.authorNameTextColor)};return Object.values(t).some(e=>e!==void 0)?t:void 0}},n=class{constructor(e,t){this.messageIndex=0,this.utils=e,this.logger=t}async curlGet(e){try{let t=await this.utils.exec(`/usr/bin/curl`,[`-s`,`-L`,`-A`,`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36`,`-H`,`Accept-Language: en-US,en;q=0.9`,e]);return t.status===0?{success:!0,body:t.stdout}:{success:!1,body:``,error:`curl failed with status ${t.status}: ${t.stderr}`}}catch(e){return{success:!1,body:``,error:`curl error: ${e}`}}}async curlPost(e,t){try{let n=await this.utils.exec(`/usr/bin/curl`,[`-s`,`-X`,`POST`,`-H`,`Content-Type: application/json`,`-A`,`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36`,`-d`,JSON.stringify(t),e]);return n.status===0?{success:!0,body:n.stdout}:{success:!1,body:``,error:`curl failed with status ${n.status}: ${n.stderr}`}}catch(e){return{success:!1,body:``,error:`curl error: ${e}`}}}async fetchMetadata(e){this.logger.log(`[LiveChatFetcher] fetchMetadata for video: ${e}`);try{let t=await this.utils.exec(`/opt/homebrew/bin/yt-dlp`,[`--dump-json`,`--no-download`,`https://www.youtube.com/watch?v=${e}`]);if(t.status!==0)return{success:!1,error:`yt-dlp failed: ${t.stderr}`};let n;try{n=JSON.parse(t.stdout)}catch{return{success:!1,error:`Failed to parse yt-dlp output`}}let r=n.is_live===!0;if(this.logger.log(`[LiveChatFetcher] yt-dlp is_live: ${r}`),!r)return{success:!1,error:`Video is not a live stream`,isNotLive:!0};let i=`https://www.youtube.com/watch?v=${e}`,a=await this.curlGet(i);if(!a.success)return{success:!1,error:a.error||`Failed to fetch video page`};let o=a.body;this.logger.log(`[LiveChatFetcher] HTML fetched, length: ${o.length}`);let s=o.match(/"INNERTUBE_API_KEY":"([^"]+)"/);if(!s)return{success:!1,error:`Could not find API key in page`};let c=s[1];this.logger.log(`[LiveChatFetcher] API key found`);let l=o.match(/"continuation":"([^"]+)"/g);if(!l||l.length===0)return{success:!1,error:`Could not find continuation token`};let u=``;for(let e of l){let t=e.replace(/"continuation":"/,``).replace(/"$/,``);t.length>u.length&&(u=t)}this.logger.log(`[LiveChatFetcher] Continuation token found, length: ${u.length}`);let d=o.match(/"INNERTUBE_CLIENT_VERSION":"([^"]+)"/),f=o.match(/"HL":"([^"]+)"/),p=o.match(/"GL":"([^"]+)"/),m={client:{hl:f?.[1]||`en`,gl:p?.[1]||`US`,clientName:`WEB`,clientVersion:d?.[1]||`2.20231219.04.00`}};return this.logger.log(`[LiveChatFetcher] Metadata fetched successfully`),{success:!0,metadata:{apiKey:c,continuation:u,context:m,isLive:r}}}catch(e){return{success:!1,error:`Failed to fetch metadata: ${e}`}}}async fetchLiveChat(e){let t=`https://www.youtube.com/youtubei/v1/live_chat/get_live_chat?key=${e.apiKey}`;try{let n=await this.curlPost(t,{context:e.context,continuation:e.continuation});if(!n.success)return{success:!1,error:n.error||`API request failed`};let r;try{if(!n.body)return{success:!1,error:`Empty response from API`};r=JSON.parse(n.body)}catch(e){return this.logger.error(`[LiveChatFetcher] Parse error: ${e}`),{success:!1,error:`Failed to parse API response`}}let i=this.parseActions(r),a=this.extractContinuationFromResponse(r);return{success:!0,messages:i,continuation:a?.continuation||null,timeoutMs:a?.timeoutMs||5e3}}catch(e){return{success:!1,error:`Failed to fetch live chat: ${e}`}}}resetMessageIndex(){this.messageIndex=0}extractContinuationFromResponse(e){let t=e.continuationContents?.liveChatContinuation?.continuations;if(t&&t.length>0){let e=t[0],n=e.timedContinuationData||e.invalidationContinuationData;if(n)return{continuation:n.continuation,timeoutMs:n.timeoutMs||5e3};if(e.reloadContinuationData)return{continuation:e.reloadContinuationData.continuation,timeoutMs:5e3}}return null}parseActions(e){let t=[],n=e.continuationContents?.liveChatContinuation?.actions;if(!n)return t;for(let e of n){let n=e.addChatItemAction?.item;if(!n)continue;let r=this.parseItem(n);r&&t.push(r)}return t}parseItem(e){let t=this.messageIndex++;if(e.liveChatTextMessageRenderer){let n=e.liveChatTextMessageRenderer,{text:r,messageRuns:i}=this.parseMessageRuns(n.message?.runs);return!r&&i.length===0?null:{id:n.id||`live-${t}`,type:`text`,timestamp:0,author:n.authorName?.simpleText||`Unknown`,authorPhoto:this.getBestThumbnail(n.authorPhoto?.thumbnails),authorChannelId:n.authorExternalChannelId,authorBadges:this.parseAuthorBadges(n.authorBadges),message:r,messageRuns:i.length>0?i:void 0,timestampText:this.formatTimestampUsec(n.timestampUsec)}}if(e.liveChatPaidMessageRenderer){let n=e.liveChatPaidMessageRenderer,{text:r,messageRuns:i}=this.parseMessageRuns(n.message?.runs);return{id:n.id||`live-${t}`,type:`superchat`,timestamp:0,author:n.authorName?.simpleText||`Unknown`,authorPhoto:this.getBestThumbnail(n.authorPhoto?.thumbnails),authorChannelId:n.authorExternalChannelId,authorBadges:this.parseAuthorBadges(n.authorBadges),message:r||`(Super Chat)`,messageRuns:i.length>0?i:void 0,timestampText:this.formatTimestampUsec(n.timestampUsec),amount:n.purchaseAmountText?.simpleText,colors:this.parseSuperChatColors(n)}}if(e.liveChatPaidStickerRenderer){let n=e.liveChatPaidStickerRenderer;return{id:n.id||`live-${t}`,type:`supersticker`,timestamp:0,author:n.authorName?.simpleText||`Unknown`,authorPhoto:this.getBestThumbnail(n.authorPhoto?.thumbnails),authorChannelId:n.authorExternalChannelId,authorBadges:this.parseAuthorBadges(n.authorBadges),message:`(Super Sticker)`,timestampText:this.formatTimestampUsec(n.timestampUsec),amount:n.purchaseAmountText?.simpleText,stickerUrl:this.getBestThumbnail(n.sticker?.thumbnails),colors:{bodyBackgroundColor:this.colorToHex(n.backgroundColor),authorNameTextColor:this.colorToHex(n.authorNameTextColor)}}}if(e.liveChatMembershipItemRenderer){let n=e.liveChatMembershipItemRenderer,{text:r}=this.parseMessageRuns(n.headerSubtext?.runs),{text:i,messageRuns:a}=this.parseMessageRuns(n.message?.runs);return{id:n.id||`live-${t}`,type:`membership`,timestamp:0,author:n.authorName?.simpleText||`Unknown`,authorPhoto:this.getBestThumbnail(n.authorPhoto?.thumbnails),authorChannelId:n.authorExternalChannelId,authorBadges:this.parseAuthorBadges(n.authorBadges),message:i||r||`(New Member)`,messageRuns:a.length>0?a:void 0,timestampText:this.formatTimestampUsec(n.timestampUsec),membershipLevel:r||void 0}}if(e.liveChatSponsorshipsGiftPurchaseAnnouncementRenderer){let n=e.liveChatSponsorshipsGiftPurchaseAnnouncementRenderer,{text:r}=this.parseMessageRuns(n.header?.liveChatSponsorshipsHeaderRenderer?.primaryText?.runs);return{id:n.id||`live-${t}`,type:`gift`,timestamp:0,author:n.authorName?.simpleText||`Unknown`,authorPhoto:this.getBestThumbnail(n.authorPhoto?.thumbnails),authorChannelId:n.authorExternalChannelId,message:r||`(Gift Membership)`,timestampText:this.formatTimestampUsec(n.timestampUsec)}}if(e.liveChatViewerEngagementMessageRenderer){let n=e.liveChatViewerEngagementMessageRenderer,{text:r,messageRuns:i}=this.parseMessageRuns(n.message?.runs);return r?{id:n.id||`live-${t}`,type:`system`,timestamp:0,author:`YouTube`,message:r,messageRuns:i.length>0?i:void 0}:null}return null}parseMessageRuns(e){if(!e?.length)return{text:``,messageRuns:[]};let t=[],n=``;for(let r of e)if(r.text)n+=r.text,t.push({type:`text`,text:r.text});else if(r.emoji){let e=r.emoji.emojiId||``,i=r.emoji.shortcuts?.[0],a=r.emoji.image?.thumbnails?.[0]?.url,o=r.emoji.isCustomEmoji;n+=i||e,t.push({type:`emoji`,emoji:{emojiId:e,shortcut:i,imageUrl:a,isCustom:o}})}return{text:n,messageRuns:t}}parseAuthorBadges(e){if(!e?.length)return;let t=[];for(let n of e){let e=n.liveChatAuthorBadgeRenderer,r=e.icon?.iconType?.toLowerCase(),i=e.tooltip||``,a;r===`verified`?a=`verified`:r===`owner`?a=`owner`:r===`moderator`?a=`moderator`:(r===`member`||e.customThumbnail)&&(a=`member`),a&&t.push({type:a,label:i,customIcon:this.getBestThumbnail(e.customThumbnail?.thumbnails)})}return t.length>0?t:void 0}getBestThumbnail(e){if(e?.length)return[...e].sort((e,t)=>(t.width||0)-(e.width||0))[0]?.url}formatTimestampUsec(e){if(e)try{let t=Number.parseInt(e,10);if(Number.isNaN(t))return;let n=new Date(t/1e3);return`${n.getHours().toString().padStart(2,`0`)}:${n.getMinutes().toString().padStart(2,`0`)}:${n.getSeconds().toString().padStart(2,`0`)}`}catch{return}}colorToHex(e){if(e===void 0)return;let t=(e>>>0).toString(16).padStart(8,`0`),n=t.slice(0,2);return`#${t.slice(2)}${n}`}parseSuperChatColors(e){let t={headerBackgroundColor:this.colorToHex(e.headerBackgroundColor),headerTextColor:this.colorToHex(e.headerTextColor),bodyBackgroundColor:this.colorToHex(e.bodyBackgroundColor),bodyTextColor:this.colorToHex(e.bodyTextColor),authorNameTextColor:this.colorToHex(e.authorNameTextColor)};return Object.values(t).some(e=>e!==void 0)?t:void 0}},{event:r,sidebar:i,standaloneWindow:a,menu:o,core:s,console:c,utils:l,preferences:u,http:d}=iina,f=new n(l,c),p=new t(l,d,c),m=null,h=[],g=null,_=!1,v=!1,y=!1,b=null,x=null,S=()=>({maxMessages:u.get(`maxMessages`)??200,scrollDirection:u.get(`scrollDirection`)??`bottom-to-top`,showTimestamp:u.get(`showTimestamp`)??!0,showAuthorName:u.get(`showAuthorName`)??!0,showAuthorPhoto:u.get(`showAuthorPhoto`)??!0,autoOpenChatWindow:u.get(`autoOpenChatWindow`)??!0,fontScale:u.get(`fontScale`)??100}),C=(e,t)=>{i.postMessage(e,t)},w=(e,t)=>{_&&v&&a.postMessage(e,t)},T=(e,t)=>{C(e,t),w(e,t)},E=e=>/^https?:\/\/(www\.)?(youtube\.com|youtu\.be)\//.test(e),D=e=>{for(let t of[/youtube\.com\/watch\?v=([^&]+)/,/youtu\.be\/([^?]+)/,/youtube\.com\/embed\/([^?]+)/]){let n=e.match(t);if(n)return n[1]}return null},O=e=>{let t=S();e(`preferences-update`,{maxMessages:t.maxMessages,scrollDirection:t.scrollDirection,showTimestamp:t.showTimestamp,showAuthorName:t.showAuthorName,showAuthorPhoto:t.showAuthorPhoto,fontScale:t.fontScale})},k=e=>{let t=Math.ceil(h.length/100);for(let n=0;n<t;n++){let r=n*100,i=Math.min(r+100,h.length);e(`chat-data-chunk`,{chunk:h.slice(r,i),chunkIndex:n,totalChunks:t,start:r,end:i})}e(`chat-data-complete`,{totalMessages:h.length})},A=()=>{x&&=(clearTimeout(x),null),y=!1,b=null},j=async()=>{if(!b||!y)return;let e=await f.fetchLiveChat(b);if(!e.success){c.error(`[pollLiveChat] Error: ${e.error}`),x=setTimeout(j,5e3);return}if(e.messages.length>0){let t=h.length===0;h.push(...e.messages),t&&c.log(`[pollLiveChat] First batch received: ${e.messages.length} messages`),T(`live-chat-messages`,{messages:e.messages})}if(e.continuation&&(b={...b,continuation:e.continuation}),y&&e.continuation){let t=Math.max(e.timeoutMs,1e3);x=setTimeout(j,t)}else A()},M=async e=>{c.log(`[startLiveChat] Starting for video: ${e}`),f.resetMessageIndex(),h=[],g=e;let t=await f.fetchMetadata(e);return t.success?(b=t.metadata,y=!0,c.log(`[startLiveChat] Live stream detected, starting polling`),T(`chat-info`,{message:`Live stream detected - fetching live chat...`}),S().autoOpenChatWindow&&H(),j(),!0):t.isNotLive?(c.log(`[startLiveChat] Not a live stream, falling back to yt-dlp`),!1):(c.error(`[startLiveChat] Failed to fetch metadata: ${t.error}`),T(`chat-error`,{message:`Failed to fetch live chat metadata`,error:t.error}),!0)},N=()=>{for(let e of[`/opt/homebrew/bin/yt-dlp`,`/usr/local/bin/yt-dlp`,`/usr/bin/yt-dlp`])if(l.fileInPath(e))return e;return`yt-dlp`},P=async e=>{let t=N();try{let n=await l.exec(t,[`--dump-json`,`--no-download`,e]);if(n.status!==0)return{available:!1,isLive:!1};let r=JSON.parse(n.stdout),i=r.is_live===!0;return{available:`live_chat`in(r.subtitles||{})||i,isLive:i}}catch{return{available:!1,isLive:!1}}},F=async e=>{try{T(`chat-loading`,{loading:!0});let t=await p.fetchAllMessages(e,e=>{T(`chat-progress`,{fetchedMessages:e.fetchedMessages,currentOffsetMs:e.currentOffsetMs,status:e.status,message:e.message})});if(!t.success)throw Error(t.error);h=t.messages,g=e,k(T),T(`chat-loading`,{loading:!1})}catch(e){T(`chat-error`,{message:`Failed to fetch chat data`,error:String(e)}),T(`chat-loading`,{loading:!1})}},I=async e=>{let t=D(e);if(!t){T(`chat-error`,{message:`Could not extract video ID`});return}A(),T(`chat-info`,{message:`Checking for chat data...`});let{available:n,isLive:r}=await P(e);if(!n){T(`chat-info`,{message:`No chat data available for this video`});return}if(r&&await M(t)){T(`chat-loading`,{loading:!1});return}S().autoOpenChatWindow&&H(),await F(t)},L=()=>{A();let e=s.status.url;if(e){if(!E(e)){T(`chat-info`,{message:`This is not a YouTube video`});return}if(!D(e)){T(`chat-error`,{message:`Could not extract YouTube video ID`});return}m=e,I(e)}},R=()=>{let e=s.status.position;!m||h.length===0||e===null||T(`position-update`,{position:e})},z=e=>{m&&I(m)},B=e=>{if(c.log(`[onSidebarReady] Sidebar ready`),O(C),!m){C(`chat-info`,{message:`Open a YouTube video to see chat`});return}let t=D(m);h.length>0&&g===t?k(C):y&&g===t?C(`chat-loading`,{loading:!0}):I(m)},V=e=>{if(v=!0,O((e,t)=>a.postMessage(e,t)),!m){a.postMessage(`chat-info`,{message:`Open a YouTube video to see chat`});return}let t=D(m);h.length>0&&g===t?k((e,t)=>a.postMessage(e,t)):a.postMessage(`chat-loading`,{loading:!0})},H=()=>{_||=(a.loadFile(`dist/sidebar/index.html`),a.onMessage(`retry-fetch`,z),a.onMessage(`sidebar-ready`,V),a.setProperty({title:`YouTube Chat`,resizable:!0,hudWindow:!0,fullSizeContentView:!0,hideTitleBar:!1}),a.setFrame(400,600,null,null),a.open(),!0)},U=()=>{_?(a.close(),_=!1,v=!1):H()};r.on(`iina.window-loaded`,()=>{c.log(`[event] iina.window-loaded`),i.loadFile(`dist/sidebar/index.html`),i.onMessage(`retry-fetch`,z),i.onMessage(`sidebar-ready`,B);let e=o.item(`Open Chat Window`,U);o.addItem(e)}),r.on(`iina.file-loaded`,e=>{L()}),r.on(`iina.window-will-close`,()=>{_&&(a.close(),_=!1,v=!1),A()}),r.on(`mpv.time-pos.changed`,R)})();